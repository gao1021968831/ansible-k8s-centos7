---
- name: Check if worker node already joined
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf_stat

- name: Get join token for workers
  shell: kubeadm token create --print-join-command
  register: worker_join_command
  delegate_to: "{{ groups['masters'][0] }}"
  run_once: true
  when: inventory_hostname in groups['workers'] and not kubelet_conf_stat.stat.exists

- name: Join worker nodes
  shell: "{{ worker_join_command.stdout }}"
  when: inventory_hostname in groups['workers'] and not kubelet_conf_stat.stat.exists
