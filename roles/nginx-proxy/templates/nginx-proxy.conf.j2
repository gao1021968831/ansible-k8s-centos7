error_log stderr notice;

worker_processes 1;
events {
  multi_accept on;
  use epoll;
  worker_connections 1024;
}

stream {
    upstream backend {
        hash $remote_addr consistent;
{% for host in groups['masters'] %}
        server {{ hostvars[host]['ansible_host'] }}:{{ kube_apiserver_port }};
{% endfor %}
    }

    # TCP proxy for HTTPS traffic
    server {
        listen 127.0.0.1:{{ nginx_proxy_port }};
        proxy_pass backend;
        proxy_timeout 10m;
        proxy_connect_timeout 10s;
    }
}
